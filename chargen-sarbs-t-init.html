<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CharGen Sarbs T</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* Paleta de Cores e Estilos Globais */
        :root { /* Dark Theme (Default) */
            --bg-main: #12181B;
            --bg-ui-main: #2A3439;
            --bg-ui-secondary: #12181B;
            --bg-ui-secondary-rgb: 18, 24, 27;
            --text-main: #FEFBF6;
            --text-secondary: #a8a29e;
            --border-color: #2A3439;
            --accent-main: #00F6ED;
            --accent-main-hover: #00d1cb;
            --accent-secondary: #FFD700;
            --accent-destructive: #b91c1c;
            --accent-destructive-hover: #991b1b;
        }

        .theme-light {
            --bg-main: #FEFBF6;
            --bg-ui-main: #FFFFFF;
            --bg-ui-secondary: #F0EBE0;
            --bg-ui-secondary-rgb: 240, 235, 224;
            --text-main: #4B0082;
            --text-secondary: #6a1a9e;
            --border-color: #d1c4e9;
            --accent-main: #FFD700;
            --accent-main-hover: #e6c200;
            --accent-secondary: #4B0082;
            --accent-destructive: #ef4444;
            --accent-destructive-hover: #dc2626;
        }

        body { 
            font-family: 'Inter', sans-serif; 
            background-color: var(--bg-main); 
            color: var(--text-main);
            transition: background-color 0.3s, color 0.3s;
        }
        .font-orbitron { font-family: 'Orbitron', sans-serif; }
        
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-ui-main); border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: var(--accent-main); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--accent-main-hover); }
        
        /* Estilos para Acorde√µes e Se√ß√µes */
        .accordion-content, .main-section-content { 
            transition: max-height 0.4s ease-in-out, padding 0.4s ease-in-out, opacity 0.3s ease-in-out;
            overflow: hidden; max-height: 0; opacity: 0; padding-top: 0; padding-bottom: 0; 
        }
        .accordion-content.open, .main-section-content.open { 
            max-height: 2500px; opacity: 1; padding-top: 1rem; padding-bottom: 1rem;
        }
        
        .selected-item { background-color: var(--accent-main) !important; color: var(--bg-main) !important; font-weight: 600; }

        /* Estilos de Formul√°rio */
        select, input, textarea {
            background-color: var(--bg-ui-main); border: 1px solid var(--border-color); color: var(--text-main); border-radius: 0.5rem; width: 100%; padding: 0.75rem 1rem; min-height: 48px;
        }
        select:focus, input:focus, textarea:focus { 
            border-color: var(--accent-main); 
            box-shadow: 0 0 0 2px var(--accent-main); 
            outline: none; 
        }

        /* Componentes UI */
        .loader {
            border: 4px solid #e5e5e5; border-top: 4px solid var(--accent-green-light); border-radius: 50%;
            width: 24px; height: 24px; animation: spin 1s linear infinite;
        }
        .small-loader { border-width: 3px; width: 18px; height: 18px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .ai-suggestion-btn {
            padding: 0.3rem; margin-left: 0.5rem; background-color: var(--accent-main); color: var(--bg-main);
            border-radius: 0.375rem; font-size: 0.75rem; line-height: 1; display: inline-flex; align-items: center;
        }
        .ai-suggestion-btn:hover { background-color: var(--accent-main-hover); }
        
        .section-arrow { transition: transform 0.3s ease; }
        .active .section-arrow { transform: rotate(180deg); }

        /* Layout Responsivo */
        #sidebar { transition: transform 0.3s ease-in-out; }
        #rascunhoSidebar { transition: transform 0.3s ease-in-out; z-index: 60; }
        #openRascunhoBtn { z-index: 55; transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out; }
        #openRascunhoBtn.hidden { opacity: 0; visibility: hidden; }

        /* Tooltips */
        .tooltip { position: relative; display: inline-block; width: 100%; }
        .tooltip .tooltip-text {
            visibility: hidden; width: 220px; background-color: var(--bg-ui-main); color: #fff;
            text-align: center; border-radius: 6px; padding: 8px; position: absolute;
            z-index: 10; bottom: 125%; left: 50%; margin-left: -110px; opacity: 0;
            transition: opacity 0.3s; font-size: 0.8rem; border: 1px solid var(--border-color);
        }
        .tooltip .tooltip-text::after {
            content: ""; position: absolute; top: 100%; left: 50%; margin-left: -5px; 
            border-width: 5px; border-style: solid; border-color: var(--bg-ui-main) transparent transparent transparent;
        }
        .tooltip:hover .tooltip-text { visibility: visible; opacity: 1; }

        /* Theme Overrides for Tailwind */
        .bg-ui-main { background-color: var(--bg-ui-main) !important; }
        .bg-emerald-600 { background-color: var(--accent-main) !important; }
        .hover\:bg-emerald-700:hover { background-color: var(--accent-main-hover) !important; }
        .text-emerald-300 { color: var(--accent-secondary) !important; }
        .text-emerald-400 { color: var(--accent-main) !important; }
        .text-emerald-600 { color: var(--accent-secondary) !important; }
        .bg-red-700 { background-color: var(--accent-destructive) !important; }
        .hover\:bg-red-800:hover { background-color: var(--accent-destructive-hover) !important; }
        .focus\:ring-emerald-500:focus { --tw-ring-color: var(--accent-main) !important; }
        .bg-stone-800 { background-color: var(--bg-ui-main) !important; }
        .border-stone-700 { border-color: var(--border-color) !important; }
        .bg-stone-900 { background-color: var(--bg-ui-secondary) !important; }
        .text-stone-200 { color: var(--text-main) !important; }
        .text-stone-300 { color: var(--text-main) !important; font-weight: 300; }
        .text-stone-400 { color: var(--text-secondary) !important; }
        .text-stone-500 { color: var(--text-secondary) !important; }
        .hover\:bg-stone-700:hover { background-color: var(--bg-ui-secondary) !important; }
        .hover\:bg-stone-700\/50:hover { background-color: rgba(var(--bg-ui-secondary-rgb), 0.5) !important; }
        .bg-green-700 { background-color: var(--accent-main) !important; }
        .hover\:bg-green-800:hover { background-color: var(--accent-main-hover) !important; }
        .bg-teal-700 { background-color: var(--accent-main) !important; }
        .hover\:bg-teal-800:hover { background-color: var(--accent-main-hover) !important; }
        .bg-lime-600 { background-color: var(--accent-secondary) !important; }
        .hover\:bg-lime-700:hover { background-color: var(--accent-main-hover) !important; }
        .bg-amber-500 { background-color: var(--accent-secondary) !important; }
        .hover\:bg-amber-600:hover { background-color: var(--accent-main-hover) !important; }
        .bg-cyan-700 { background-color: var(--accent-main) !important; }
        .hover\:bg-cyan-800:hover { background-color: var(--accent-main-hover) !important; }
        .bg-green-600 { background-color: var(--accent-main) !important; }
        .hover\:bg-green-700:hover { background-color: var(--accent-main-hover) !important; }
        .text-teal-400 { color: var(--accent-main) !important; }
    </style>
</head>
<body class="p-4 md:p-6">

    <!-- Bot√£o e Sidebar de Rascunho -->
    <button id="openRascunhoBtn" class="fixed top-1/2 right-0 transform -translate-y-1/2 bg-emerald-600 hover:bg-emerald-700 text-white p-3 rounded-l-lg shadow-lg" aria-label="Abrir rascunho de ideias">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" /></svg>
    </button>
    <div id="rascunhoSidebar" class="fixed top-0 right-0 h-full w-full sm:w-80 md:w-96 bg-stone-800 shadow-xl transform translate-x-full p-4 flex flex-col border-l border-stone-700">
        <div class="flex justify-between items-center mb-4">
            <h3 class="font-orbitron text-lg text-emerald-300">Rascunho de Ideias</h3>
            <button id="closeRascunhoBtn" class="text-stone-300 hover:text-white p-1 rounded-md hover:bg-stone-700" aria-label="Fechar rascunho de ideias">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
        </div>
        <textarea id="rascunhoTextarea" class="w-full flex-grow p-2 bg-stone-900 border-stone-700 rounded-md text-stone-200 text-sm mb-4 resize-none" placeholder="Digite ou gere ideias aqui..."></textarea>
        <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2">
            <button id="addRascunhoToPromptBtn" class="flex-1 bg-emerald-600 hover:bg-emerald-700 text-white font-semibold py-2 px-3 rounded-lg text-sm">Adicionar ao Prompt</button>
            <button id="clearRascunhoBtn" class="flex-1 bg-red-700 hover:bg-red-800 text-white font-semibold py-2 px-3 rounded-lg text-sm">Limpar Rascunho</button>
        </div>
    </div>

    <!-- Header Principal -->
    <header class="flex justify-between items-center mb-6 pb-4 border-b border-stone-700">
        <h1 class="font-orbitron text-2xl md:text-3xl font-bold text-emerald-400">CharGen <span class="text-emerald-600">Sarbs T</span></h1>
        <div class="flex items-center space-x-2">
            <button id="theme-switcher" class="p-2 rounded-md hover:bg-stone-700 focus:outline-none focus:ring-2 focus:ring-emerald-500" aria-label="Alternar tema">
                <svg id="theme-icon-light" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>
                <svg id="theme-icon-dark" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>
            </button>
            <button id="settings-btn" class="p-2 rounded-md hover:bg-stone-700 focus:outline-none focus:ring-2 focus:ring-emerald-500" aria-label="Abrir configura√ß√µes">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.096 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
            </button>
            <button id="hamburger-btn" class="p-2 rounded-md hover:bg-stone-700 focus:outline-none focus:ring-2 focus:ring-emerald-500 md:hidden" aria-label="Abrir menu de categorias">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16" /></svg>
            </button>
        </div>
    </header>

    <div class="md:grid md:grid-cols-12 md:gap-8">
        
        <!-- Sidebar de Categorias -->
        <aside id="sidebar" class="md:col-span-4 lg:col-span-3 fixed md:relative top-0 left-0 h-full w-80 md:w-auto bg-stone-900 md:bg-transparent shadow-xl md:shadow-none transform -translate-x-full md:translate-x-0 z-40 p-4 md:p-0">
            <div class="flex justify-between items-center mb-4 pb-4 border-b border-stone-700 md:hidden">
                 <h2 class="font-orbitron text-xl text-emerald-300">Categorias</h2>
                 <button id="close-sidebar-btn" class="p-2 rounded-md hover:bg-stone-700" aria-label="Fechar menu de categorias">
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                 </button>
            </div>
            <div class="h-full overflow-y-auto pr-2 pb-40">
                 <form id="characterForm">
                     <div id="categories-container" class="space-y-2">
                         <!-- Categorias ser√£o inseridas aqui dinamicamente -->
                     </div>
                 </form>
            </div>
        </aside>

        <!-- Conte√∫do Principal -->
        <main class="md:col-span-8 lg:col-span-9 space-y-4 pb-40">
            
            <!-- Se√ß√£o de An√°lise por IA -->
            <div class="bg-stone-800 rounded-lg shadow-xl">
                <button class="main-section-header w-full p-4 flex justify-between items-center text-left hover:bg-stone-700/50 transition-colors rounded-lg" aria-expanded="false">
                    <h2 class="font-orbitron text-xl text-emerald-300 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 mr-3 text-emerald-400"><path stroke-linecap="round" stroke-linejoin="round" d="M10.05 4.575a1.575 1.575 0 1 0-3.15 0v3m3.15-3v-1.5a1.575 1.575 0 0 1 3.15 0v1.5m-3.15 0S8.505 4.5 8.25 4.5m5.625 4.5H18a2.25 2.25 0 0 1 2.25 2.25v3.75a2.25 2.25 0 0 1-2.25 2.25H13.875m0 0A2.25 2.25 0 0 1 11.625 15h-1.5a2.25 2.25 0 0 1-2.25-2.25V8.625c0-.621.504-1.125 1.125-1.125h1.5a2.25 2.25 0 0 1 2.25 2.25Z" /></svg>
                        An√°lise com IA
                    </h2>
                     <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 section-arrow text-stone-400"><path stroke-linecap="round" stroke-linejoin="round" d="m19.5 8.25-7.5 7.5-7.5-7.5" /></svg>
                </button>
                <div class="main-section-content px-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="imageUpload" class="block text-sm font-medium text-stone-300 mb-1">Upload de Imagem (PNG, JPG, WEBP - max 4MB)</label>
                            <input type="file" id="imageUpload" accept="image/png, image/jpeg, image/webp" class="w-full text-sm text-stone-400 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-emerald-600 file:text-white hover:file:bg-emerald-700 cursor-pointer">
                            <div id="imagePreviewContainer" class="mt-4 w-full h-48 bg-stone-700 rounded-lg flex items-center justify-center overflow-hidden mx-auto">
                                <img id="imagePreview" src="#" alt="Pr√©-visualiza√ß√£o da Imagem" class="hidden max-h-full max-w-full object-contain">
                                <span id="imagePreviewPlaceholder" class="text-stone-500">Pr√©-visualiza√ß√£o</span>
                            </div>
                            <button id="analyzeImageBtn" class="mt-2 w-full bg-green-700 hover:bg-green-800 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition-colors flex items-center justify-center text-sm">Analisar Imagem <div id="analyzeLoader" class="loader small-loader ml-3 hidden"></div></button>
                            <p class="text-xs text-stone-500 mt-1 text-center">(Requer uma chave de API do Google Gemini nas configura√ß√µes)</p>
                        </div>
                        <div>
                            <label for="analyzeTxtFileInput" class="block text-sm font-medium text-stone-300 mb-1">Upload de Texto (.txt)</label>
                            <input type="file" id="analyzeTxtFileInput" class="w-full text-sm text-stone-400 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-emerald-600 file:text-white hover:file:bg-emerald-700 cursor-pointer">
                             <div class="mt-4 w-full h-48 bg-stone-700 rounded-lg flex items-center justify-center overflow-hidden mx-auto p-2">
                                 <p class="text-stone-500 text-center text-sm">A IA pode analisar uma descri√ß√£o textual e preencher os campos do formul√°rio.</p>
                             </div>
                            <button id="analyzeTxtAndFillBtn" class="mt-2 w-full bg-teal-700 hover:bg-teal-800 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition-colors flex items-center justify-center text-sm">Analisar Texto <div id="analyzeTxtLoader" class="loader small-loader ml-3 hidden"></div></button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Se√ß√£o do Prompt Final -->
            <div class="bg-stone-800 rounded-lg shadow-xl">
                <button class="main-section-header w-full p-4 flex justify-between items-center text-left hover:bg-stone-700/50 transition-colors rounded-lg" aria-expanded="false">
                    <h2 class="font-orbitron text-xl text-emerald-300 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 mr-3 text-emerald-400"><path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10" /></svg>
                        Seu Prompt Final
                    </h2>
                     <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 section-arrow text-stone-400"><path stroke-linecap="round" stroke-linejoin="round" d="m19.5 8.25-7.5 7.5-7.5-7.5" /></svg>
                </button>
                <div class="main-section-content px-4">
                    <textarea id="generatedPrompt" rows="8" class="w-full p-3 bg-stone-900 border-stone-700 rounded-lg text-stone-200 text-sm" placeholder="Selecione as op√ß√µes na barra lateral, use a IA para gerar detalhes e clique em 'Gerar Prompt'..."></textarea>
                    <div class="mt-4 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-3">
                        <button id="generateCompactPromptBtn" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 px-3 rounded-lg shadow-xl transition-transform hover:scale-105 text-sm">Gerar Compacto</button>
                        <button id="generateDetailedPromptBtn" class="w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-3 rounded-lg shadow-xl transition-transform hover:scale-105 text-sm">Gerar Detalhado</button>
                        <button id="copyPromptBtn" class="w-full bg-lime-600 hover:bg-lime-700 text-white font-semibold py-2 px-3 rounded-lg shadow-md text-sm">Copiar</button>
                        <button id="randomizeAllBtn" class="w-full bg-amber-500 hover:bg-amber-600 text-white font-semibold py-2 px-3 rounded-lg shadow-md text-sm">Aleatorizar</button>
                        <button id="clearAllBtn" class="w-full bg-red-700 hover:bg-red-800 text-white font-semibold py-2 px-3 rounded-lg shadow-md text-sm">Limpar Tudo</button>
                    </div>
                </div>
            </div>

            <!-- Se√ß√£o de Gera√ß√£o de Imagem -->
            <div class="bg-stone-800 rounded-lg shadow-xl">
                 <button class="main-section-header w-full p-4 flex justify-between items-center text-left hover:bg-stone-700/50 transition-colors rounded-lg" aria-expanded="false">
                    <h2 class="font-orbitron text-xl text-emerald-300 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 mr-3 text-teal-400"><path stroke-linecap="round" stroke-linejoin="round" d="m2.25 15.75 5.159-5.159a2.25 2.25 0 0 1 3.182 0l5.159 5.159m-1.5-1.5 1.409-1.409a2.25 2.25 0 0 1 3.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 0 0 1.5-1.5V6a1.5 1.5 0 0 0-1.5-1.5H3.75A1.5 1.5 0 0 0 2.25 6v12a1.5 1.5 0 0 0 1.5 1.5Zm10.5-11.25h.008v.008h-.008V8.25Zm.375 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Z" /></svg>
                        Pr√©-visualiza√ß√£o da Imagem por IA
                    </h2>
                     <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 section-arrow text-stone-400"><path stroke-linecap="round" stroke-linejoin="round" d="m19.5 8.25-7.5 7.5-7.5-7.5" /></svg>
                </button>
                <div class="main-section-content px-4">
                    <div class="flex flex-col items-center">
                        <button id="generateImagePreviewBtn" class="w-full md:w-2/3 bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-3 px-4 rounded-lg shadow-xl transition-transform hover:scale-105 mb-4 flex items-center justify-center">
                            Gerar Imagem do Personagem com IA
                            <div id="imageGenLoader" class="loader ml-3 hidden"></div>
                        </button>
                        <div id="generatedImageContainer" class="w-full md:w-96 h-96 bg-stone-700 rounded-lg flex items-center justify-center overflow-hidden">
                            <img id="generatedImagePreview" src="#" alt="Imagem Gerada pela IA" class="hidden max-h-full max-w-full object-contain">
                            <span id="generatedImagePlaceholder" class="text-stone-500">A imagem gerada aparecer√° aqui...</span>
                        </div>
                        <p class="text-xs text-stone-400 mt-2 text-center">Utiliza o "Prompt Final" para gerar a imagem.</p>
                    </div>
                </div>
            </div>
            
            <!-- Se√ß√£o de Gerenciamento -->
            <div class="bg-stone-800 rounded-lg shadow-xl">
                 <button class="main-section-header w-full p-4 flex justify-between items-center text-left hover:bg-stone-700/50 transition-colors rounded-lg" aria-expanded="false">
                    <h2 class="font-orbitron text-xl text-emerald-300 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 mr-3 text-teal-400">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M20.25 6.375c0 2.278-3.694 4.125-8.25 4.125S3.75 8.653 3.75 6.375m16.5 0c0-2.278-3.694-4.125-8.25-4.125S3.75 4.097 3.75 6.375m16.5 0v11.25c0 2.278-3.694 4.125-8.25 4.125s-8.25-1.847-8.25-4.125V6.375" />
                        </svg>
                        Gerenciamento
                    </h2>
                     <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 section-arrow text-stone-400"><path stroke-linecap="round" stroke-linejoin="round" d="m19.5 8.25-7.5 7.5-7.5-7.5" /></svg>
                </button>
                <div class="main-section-content px-4">
                     <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div class="flex flex-col space-y-2">
                            <label class="block text-sm font-medium text-stone-300 mb-1">Salvar/Carregar</label>
                            <button id="saveCharacterBtn" class="w-full bg-cyan-700 hover:bg-cyan-800 text-white font-semibold py-2 px-3 rounded-lg shadow-md text-sm">Salvar Ficha (.json)</button>
                            <button id="loadCharacterBtn" class="w-full bg-teal-700 hover:bg-teal-800 text-white font-semibold py-2 px-3 rounded-lg shadow-md text-sm">Carregar Ficha (.json)</button>
                            <input type="file" id="loadCharacterFileInput" class="hidden" accept=".json,.txt">
                        </div>
                         <div>
                            <label for="presets" class="block text-sm font-medium text-stone-300 mb-1">Presets</label>
                            <select id="presets" name="presets" class="w-full p-2 mb-2"></select>
                            <button id="applyPresetBtn" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-3 rounded-lg shadow-md text-sm">Aplicar Preset</button>
                        </div>
                     </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Notifica√ß√£o Toast -->
    <div id="toast-notification" class="fixed bottom-5 right-5 bg-emerald-600 text-white py-3 px-6 rounded-lg shadow-xl text-sm z-50 transition-all duration-300 opacity-0 transform translate-y-10" role="alert" aria-live="assertive"></div>

    <!-- Settings Modal -->
<div id="settings-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center hidden z-50 p-4">
    <div class="bg-ui-main p-4 sm:p-6 rounded-lg shadow-xl w-full max-w-lg max-h-[90vh] flex flex-col">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-orbitron">Configura√ß√µes</h2>
            <button id="close-settings-btn" class="text-text-main text-3xl leading-none hover:text-accent-main p-1">&times;</button>
        </div>

        <!-- Abas do Modal -->
        <div class="border-b border-border-color mb-4">
            <nav class="-mb-px flex space-x-4" aria-label="Tabs">
                <button data-tab="text-gen" class="tab-btn whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm text-accent-main border-accent-main">
                    Gera√ß√£o de Texto
                </button>
                <button data-tab="image-gen" class="tab-btn whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm text-text-secondary border-transparent hover:text-text-main hover:border-text-secondary">
                    Gera√ß√£o de Imagem
                </button>
                <button data-tab="debug" class="tab-btn whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm text-text-secondary border-transparent hover:text-text-main hover:border-text-secondary">
                    Logs
                </button>
            </nav>
        </div>

        <div class="flex-grow overflow-y-auto pr-2 space-y-4">
            <!-- Conte√∫do da Aba: Gera√ß√£o de Texto -->
            <div id="text-gen" class="tab-content space-y-4">
                <div>
                    <label for="text-api-provider" class="block text-sm font-medium text-text-secondary mb-1">Provedor de IA de Texto</label>
                    <select id="text-api-provider" name="text-api-provider">
                        <option value="google">Google Gemini</option>
                        <option value="huggingface">Hugging Face</option>
                    </select>
                </div>
                <div id="google-settings">
                    <label for="google-api-key" class="block text-sm font-medium text-text-secondary mb-1">Chave de API do Google</label>
                    <input type="password" id="google-api-key" placeholder="Cole sua chave do AI Studio aqui">
                </div>
                <div id="huggingface-settings" class="hidden space-y-4">
                    <div>
                        <label for="huggingface-api-key" class="block text-sm font-medium text-text-secondary mb-1">Token de Acesso do Hugging Face</label>
                        <input type="password" id="huggingface-api-key" placeholder="Cole seu token (hf_...) aqui">
                    </div>
                    <div>
                        <label for="huggingface-model-id" class="block text-sm font-medium text-text-secondary mb-1">ID do Modelo (ex: mistralai/Mistral-7B)</label>
                        <input type="text" id="huggingface-model-id" placeholder="Ex: mistralai/Mistral-7B-Instruct-v0.2">
                    </div>
                    <input type="hidden" id="huggingface-task-type" value="text-generation"> <!-- Campo escondido, valor padr√£o -->
                </div>
            </div>

            <!-- Conte√∫do da Aba: Gera√ß√£o de Imagem -->
            <div id="image-gen" class="tab-content hidden space-y-4">
                 <div>
                    <label for="image-api-provider" class="block text-sm font-medium text-text-secondary mb-1">Provedor de IA de Imagem</label>
                    <select id="image-api-provider" name="image-api-provider">
                        <option value="google">Google Imagen</option>
                        <option value="huggingface">Hugging Face (Stable Diffusion)</option>
                    </select>
                     <p class="text-xs text-stone-500 mt-1">A chave de API do Google e o token do Hugging Face s√£o os mesmos da aba de texto.</p>
                </div>
                 <input type="hidden" id="clipdrop-api-key" value=""> <!-- Campo escondido, n√£o usado na nova vers√£o -->
            </div>

            <!-- Conte√∫do da Aba: Logs -->
            <div id="debug" class="tab-content hidden space-y-2">
                <div class="flex justify-between items-center">
                    <h4 class="text-sm font-medium">Logs do Sistema</h4>
                    <div class="flex items-center space-x-2 flex-wrap">
                        <button id="clear-logs" class="px-2 py-1 text-xs bg-red-600 text-white rounded hover:bg-red-700">Limpar</button>
                        <button id="export-logs-txt" class="px-2 py-1 text-xs bg-blue-600 text-white rounded hover:bg-blue-700">TXT</button>
                        <button id="export-logs-json" class="px-2 py-1 text-xs bg-green-600 text-white rounded hover:bg-green-700">JSON</button>
                        <label for="import-logs-json-input" class="px-2 py-1 text-xs bg-purple-600 text-white rounded hover:bg-purple-700 cursor-pointer">Importar</label>
                        <input type="file" id="import-logs-json-input" class="hidden" accept=".json">
                    </div>
                </div>
                <div id="debug-output" class="bg-gray-900 text-green-400 text-xs p-3 rounded-lg h-64 overflow-y-auto font-mono">
                    <p>[Logs do sistema aparecer√£o aqui...]</p>
                </div>
            </div>
        </div>

        <!-- Rodap√© do Modal -->
        <div class="mt-6 pt-4 border-t border-border-color flex justify-between items-center">
             <!-- Toggle Debug -->
            <div class="flex items-center">
              <label for="debug-mode" class="text-sm font-medium text-text-secondary mr-2">Modo Debug</label>
              <input id="debug-mode" type="checkbox" class="h-4 w-4 rounded border-gray-300 text-accent-main focus:ring-accent-main">
            </div>
            <button id="save-settings-btn" class="bg-accent-main hover:bg-accent-main-hover text-bg-main font-bold py-2 px-6 rounded-lg">Salvar</button>
        </div>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  let DEBUG = false;
  let logHistory = []; // guarda objetos estruturados

  // -------------------------
  // üîπ Utilit√°rios e Logs
  // -------------------------
  function logDebug(...args) {
    if (DEBUG) {
      const entry = {
        timestamp: new Date().toISOString(),
        message: args.map(a => (typeof a === "object" ? JSON.stringify(a) : a)).join(" ")
      };
      console.log("[Chargen DEBUG]", entry.message);
      logHistory.push(entry);
      updateLogPanel();
    }
  }

  function updateLogPanel() {
      const output = document.getElementById("debug-output");
      if (output) {
          output.innerHTML = ''; // Limpa antes de redesenhar
          logHistory.forEach(entry => {
              const line = document.createElement("p");
              line.textContent = `[${new Date(entry.timestamp).toLocaleTimeString()}] ${entry.message}`;
              output.appendChild(line);
          });
          output.scrollTop = output.scrollHeight;
      }
  }

  function clearLogs() {
    logHistory = [];
    updateLogPanel();
    const output = document.getElementById("debug-output");
    if(output) output.innerHTML = "<p>[Logs limpos]</p>";
    console.clear();
  }

  function exportLogsTXT() {
    if (logHistory.length === 0) return showToast("Nenhum log para exportar!", true);
    const text = logHistory.map(l => `[${l.timestamp}] ${l.message}`).join("\n");
    const blob = new Blob([text], { type: "text/plain" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `chargen-logs-${new Date().toISOString()}.txt`;
    a.click();
    URL.revokeObjectURL(url);
    a.remove();
  }

  function exportLogsJSON() {
    if (logHistory.length === 0) return showToast("Nenhum log para exportar!", true);
    const blob = new Blob([JSON.stringify(logHistory, null, 2)], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `chargen-logs-${new Date().toISOString()}.json`;
    a.click();
    URL.revokeObjectURL(url);
    a.remove();
  }

  function importLogsJSON(file) {
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (e) => {
          try {
              const importedLogs = JSON.parse(e.target.result);
              if (Array.isArray(importedLogs) && importedLogs.every(log => log.timestamp && log.message)) {
                  logHistory = importedLogs;
                  logHistory.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp)); // Garante a ordem
                  updateLogPanel();
                  showToast("Logs importados com sucesso!");
              } else {
                  showToast("Arquivo JSON inv√°lido ou formato incorreto.", true);
              }
          } catch (err) {
              showToast("Erro ao ler o arquivo JSON.", true);
              logDebug("Erro na importa√ß√£o de JSON:", err);
          }
      };
      reader.readAsText(file);
  }

  function showToast(msg, isError = false) {
    const toast = document.getElementById("toast-notification");
    toast.textContent = msg;
    toast.classList.remove("opacity-0", "translate-y-10");
    toast.classList.add(isError ? "bg-red-700" : "bg-emerald-600");
    setTimeout(() => {
      toast.classList.add("opacity-0", "translate-y-10");
    }, 4000);
    logDebug(isError ? "[ERRO]" : "[INFO]", msg);
  }

  // -------------------------
  // üîπ Configura√ß√µes (Save/Load)
  // -------------------------
  function saveSettings() {
    const settings = {
      textProvider: document.getElementById("text-api-provider").value,
      googleKey: document.getElementById("google-api-key").value,
      huggingKey: document.getElementById("huggingface-api-key").value,
      huggingModel: document.getElementById("huggingface-model-id").value,
      imageProvider: document.getElementById("image-api-provider").value,
      debugMode: document.getElementById("debug-mode").checked,
    };
    localStorage.setItem("chargen-settings", JSON.stringify(settings));
    DEBUG = settings.debugMode;
    logDebug("Configura√ß√µes salvas:", settings);
    return settings;
  }

  function loadSettings() {
    const saved = localStorage.getItem("chargen-settings");
    if (saved) {
      const s = JSON.parse(saved);
      document.getElementById("text-api-provider").value = s.textProvider || 'google';
      document.getElementById("google-api-key").value = s.googleKey || "";
      document.getElementById("huggingface-api-key").value = s.huggingKey || "";
      document.getElementById("huggingface-model-id").value = s.huggingModel || "";
      document.getElementById("image-api-provider").value = s.imageProvider || 'google';
      document.getElementById("debug-mode").checked = !!s.debugMode;
      DEBUG = !!s.debugMode;
      logDebug("Configura√ß√µes carregadas:", s);
      // Disparar eventos para garantir que a UI esteja correta
      document.getElementById("text-api-provider").dispatchEvent(new Event('change'));
    }
  }

  // -------------------------
  // üîπ Chamadas de API
  // -------------------------
  async function callHuggingFaceText(prompt, settings) {
    logDebug("Chamando Hugging Face (Texto)...");
    if (!settings.huggingKey || !settings.huggingModel) throw new Error("Token ou modelo Hugging Face n√£o configurados.");
    const url = `https://api-inference.huggingface.co/models/${settings.huggingModel}`;
    const response = await fetch(url, {
      method: "POST",
      headers: { "Authorization": `Bearer ${settings.huggingKey}`, "Content-Type": "application/json" },
      body: JSON.stringify({ inputs: prompt })
    });
    if (!response.ok) throw new Error(`Erro HF Texto: ${response.status}`);
    const data = await response.json();
    logDebug("Resposta HF (Texto):", data);
    if (Array.isArray(data) && data[0]?.generated_text) return data[0].generated_text;
    if (data.error) throw new Error(data.error);
    return JSON.stringify(data);
  }

  async function callHuggingFaceImage(prompt, settings) {
    logDebug("Chamando Hugging Face (Imagem)...");
    if (!settings.huggingKey) throw new Error("Token Hugging Face n√£o configurado.");
    const model = "stabilityai/stable-diffusion-xl-base-1.0";
    const url = `https://api-inference.huggingface.co/models/${model}`;
    const response = await fetch(url, {
      method: "POST",
      headers: { "Authorization": `Bearer ${settings.huggingKey}` },
      body: JSON.stringify({ inputs: prompt })
    });
    if (!response.ok) throw new Error(`Erro HF Imagem: ${response.status}`);
    const blob = await response.blob();
    logDebug("Imagem HF gerada.");
    return URL.createObjectURL(blob);
  }

  async function callGoogleGeminiText(prompt, settings) {
    logDebug("Chamando Google Gemini (Texto)...");
    if (!settings.googleKey) throw new Error("Chave Google Gemini n√£o configurada.");
    const model = "gemini-pro";
    const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${settings.googleKey}`;
    const response = await fetch(url, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
    });
    if (!response.ok) throw new Error(`Erro Google Texto: ${response.status}`);
    const data = await response.json();
    logDebug("Resposta Google (Texto):", data);
    return data?.candidates?.[0]?.content?.parts?.[0]?.text || "Sem resposta do Google.";
  }

  // Google Imagen n√£o tem uma API p√∫blica simples como a do Gemini, ent√£o vamos manter o HuggingFace como padr√£o para imagem por enquanto.
  // A fun√ß√£o abaixo √© um placeholder caso o usu√°rio queira adaptar para uma API diferente.
  async function callGoogleImagen(prompt, settings) {
      logDebug("Google Imagen n√£o tem API p√∫blica de acesso direto simples. Usando fallback para Hugging Face.");
      throw new Error("API Google Imagen n√£o implementada diretamente.");
  }


  // -------------------------
  // üîπ L√≥gica com Fallback
  // -------------------------
  async function generateText(prompt, settings) {
    const primary = settings.textProvider === 'huggingface' ? callHuggingFaceText : callGoogleGeminiText;
    const fallback = settings.textProvider === 'huggingface' ? callGoogleGeminiText : callHuggingFaceText;

    try {
      logDebug(`Tentando provedor prim√°rio de texto: ${settings.textProvider}`);
      return await primary(prompt, settings);
    } catch (err) {
      logDebug(`Erro no prim√°rio (${settings.textProvider}):`, err.message);
      showToast(`Falha em ${settings.textProvider}. Tentando fallback...`, true);
      try {
        const fallbackProvider = settings.textProvider === 'huggingface' ? 'google' : 'huggingface';
        logDebug(`Tentando provedor de fallback de texto: ${fallbackProvider}`);
        return await fallback(prompt, settings);
      } catch (finalErr) {
        logDebug("Fallback tamb√©m falhou:", finalErr.message);
        throw finalErr;
      }
    }
  }

  async function generateImage(prompt, settings) {
    // Simplificando: HuggingFace √© o √∫nico provedor de imagem funcional nesta vers√£o.
    // O seletor no HTML √© mantido para extensibilidade futura.
    try {
        logDebug("Usando Hugging Face para gera√ß√£o de imagem.");
        return await callHuggingFaceImage(prompt, settings);
    } catch (err) {
        logDebug("Erro na gera√ß√£o de imagem:", err.message);
        throw err;
    }
  }

  // -------------------------
  // üîπ Event Listeners
  // -------------------------
  function setupEventListeners() {
      // Modal de Configura√ß√µes
      document.getElementById("settings-btn").addEventListener("click", () => document.getElementById("settings-modal").classList.remove("hidden"));
      document.getElementById("close-settings-btn").addEventListener("click", () => document.getElementById("settings-modal").classList.add("hidden"));
      document.getElementById("save-settings-btn").addEventListener("click", () => {
          saveSettings();
          document.getElementById("settings-modal").classList.add("hidden");
          showToast("Configura√ß√µes salvas!");
      });

      // Abas do Modal
      document.querySelectorAll(".tab-btn").forEach(btn => {
          btn.addEventListener('click', () => {
              const tabId = btn.dataset.tab;
              document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));
              document.getElementById(tabId).classList.remove('hidden');

              document.querySelectorAll('.tab-btn').forEach(b => {
                  b.classList.remove('text-accent-main', 'border-accent-main');
                  b.classList.add('text-text-secondary', 'border-transparent');
              });
              btn.classList.add('text-accent-main', 'border-accent-main');
              btn.classList.remove('text-text-secondary', 'border-transparent');
          });
      });

      // Visibilidade dos campos de API
      document.getElementById("text-api-provider").addEventListener('change', (e) => {
          const isGoogle = e.target.value === 'google';
          document.getElementById('google-settings').classList.toggle('hidden', !isGoogle);
          document.getElementById('huggingface-settings').classList.toggle('hidden', isGoogle);
      });

      // Bot√µes de Gera√ß√£o de Prompt
      document.getElementById("generateCompactPromptBtn").addEventListener("click", async () => {
          const settings = saveSettings(); // Salva antes de usar
          const promptBase = document.getElementById("generatedPrompt").value || "Crie um prompt compacto para gerar uma cena de personagem baseado em fantasia.";
          try {
              const text = await generateText(promptBase, settings);
              document.getElementById("generatedPrompt").value = text;
              showToast("Prompt gerado com sucesso!");
          } catch (err) {
              showToast(err.message, true);
          }
      });

      document.getElementById("generateDetailedPromptBtn").addEventListener("click", async () => {
          const settings = saveSettings();
          const promptBase = document.getElementById("generatedPrompt").value || "Crie um prompt detalhado e descritivo para gerar uma cena de personagem em estilo √©pico.";
          try {
              const text = await generateText(promptBase, settings);
              document.getElementById("generatedPrompt").value = text;
              showToast("Prompt detalhado gerado!");
          } catch (err) {
              showToast(err.message, true);
          }
      });

      // Bot√£o de Gera√ß√£o de Imagem
      document.getElementById("generateImagePreviewBtn").addEventListener("click", async () => {
          const settings = saveSettings();
          const prompt = document.getElementById("generatedPrompt").value;
          if (!prompt) return showToast("Gere ou escreva um prompt primeiro.", true);

          const loader = document.getElementById("imageGenLoader");
          const preview = document.getElementById("generatedImagePreview");
          const placeholder = document.getElementById("generatedImagePlaceholder");

          try {
              loader.classList.remove("hidden");
              preview.classList.add("hidden");
              placeholder.classList.remove("hidden");

              const imgUrl = await generateImage(prompt, settings);

              preview.src = imgUrl;
              preview.classList.remove("hidden");
              placeholder.classList.add("hidden");
              showToast("Imagem gerada com sucesso!");
          } catch (err) {
              showToast(err.message, true);
              placeholder.textContent = "Falha ao gerar imagem.";
          } finally {
              loader.classList.add("hidden");
          }
      });

      // Bot√µes de Logs
      document.getElementById("clear-logs").addEventListener("click", clearLogs);
      document.getElementById("export-logs-txt").addEventListener("click", exportLogsTXT);
      document.getElementById("export-logs-json").addEventListener("click", exportLogsJSON);
      document.getElementById("import-logs-json-input").addEventListener("change", (e) => {
          importLogsJSON(e.target.files[0]);
          e.target.value = ''; // Reseta o input para poder importar o mesmo arquivo de novo
      });
  }

  // -------------------------
  // üîπ Inicializa√ß√£o
  // -------------------------
  loadSettings();
  setupEventListeners();
  logDebug("CharGen inicializado.");
});
</script>
</body>
</html>
